---
title: "Secondary siRNA Screen Validation - LMNA/LMNB"
author: "Andria Schibler/Gianluca Pegoraro"
date: "March 27th 2023"
output:
  html_document: default
  html_notebook: default
---

### Introduction

This script is used to analyze siRNA screen validation data obtained with High-Content Image analysis. In particular, the siRNA library used is the Dharmacon generated by Andria Schibler and Pedja Jevtic, based on the primary siRNA screen results using the Epigenetics and Custom Nuclear Envelope libraries from ThermoFisher.

The siRNA library was originally received dried in 96 well plates at 0.25 nM. It was resuspended and mixed in 50 ul nuclease-free water to obtain a final concentration of 5 uM, frozen overnight and then thawed to increase oligo siRNA solubility.45 ul were aspirated from the original source plate and dispensed into separate wells to generate a 384 well master Plate. These siRNAs occupied columns 1 to 22 (Partial). All these liquid handling operations were performed using a PerkinElmer Janus instrument, which output all the liquid handling operations logs as text files.384 well imaging ready plates containing spotted siRNA (300 nl) were generated using an Echo525. 300 of ul control siRNA (5uM) were then added to their respective wells in columns 22, 23 and 24. The imaging assay ready plates were sealed with aluminum sealing foil and stored at -20oC until use.

Imaging Assay plates were dried, frozen and then used in reverse transfection experiments. For reverese transfection, plates were thawed, spinned and 20 ul of Optimem + 0.05 ul/well of RNAiMax were added to the plates and incubated for 30'. Then 20 ul of cells were added on top of the siRNA/RNAiMax mix and incubated for 72 hrs.

Fixed and stained plates were imaged on an Opera QEHS microscope using a 40X water immersion objectives. Images were analyzed in Columbus 2.8.1, and image analysis results were exported as tab delimited .txt files.

The script reads library reformatting files used on the Echo (Containing the siRNA layout), the Columbus image analysis results and generates statistical analysis.

### Ab markers:

-   Green: LMNB
-   Red: LMNA

### Load packages.

```{r, warning=FALSE}
library(plyr)
library(tidyverse)
library(knitr)
library(data.table)
library(ggthemes)
library(viridis)
```

```{r, include=FALSE, warning=FALSE}
opts_chunk$set(
    fig.path = "output/",
    cache = FALSE,
    fig.width = 15,
    fig.height = 7,
    message = FALSE,
    warning = FALSE
    )
```

```{r setThemeandPalette, include='false'}
theme_set(theme_minimal())
theme_update(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5))
```

### Read the siRNA layouts and generate a control layout

Set channel variable names.

```{r}
green_name = "LMNB"
red_name = "LMNA"
```

Read the siRNA layout information provided by Dharmacon and select only relevant columns. The custom cherry pick work list file that was generated by the Janus to reformat the siRNA oligos from 96 well to 384.

```{r geneListRead}
dt_siRNA <- fread(input = "Cherry_Pick_Worklist.csv")

setnames(dt_siRNA, c("dest_col", 
                  "dest_row",
                  "dest_well"), 
                c("Column",
                  "Row",
                  "WellName"))

glimpse(dt_siRNA)
```

Create a control layout data.table that contains the positions of the library (`sample`), empty wells (`empty`), and controls (`negative`, `positive1` or LMNB1, `positive2` or SYNE2, `positive3` or LMNA, and `killer`).

```{r controlLayout}
dt_control <- data.table(Column = rep(1:24, each = 16), Row = rep(1:16, 24))
dt_control[, WellName := paste0(LETTERS[Row], Column)]
dt_control[Column %in% 1:21, treatment := "sample"]
dt_control[Column == 22 & Row %in% 1:4, treatment := "sample"]
dt_control[Column == 22 & Row %in% 5:12, treatment := "LMNA"]
dt_control[Column == 22 & Row %in% 13:16, treatment := "empty"]
dt_control[Column %in% 23 & Row %in% seq(1, 16, 2), treatment := "negative"]
dt_control[Column %in% 23 & Row %in% seq(2, 16, 2), treatment := "killer"]
dt_control[Column %in% 24 & Row %in% seq(1, 16, 2), treatment := "LMNB1"]
dt_control[Column %in% 24 & Row %in% seq(2, 16, 2), treatment := "SYNE2"]

glimpse(dt_control)
```

Merge the control layout and the siRNA layout data.tables.

```{r siRNAControlMerge}
dt_layout <- dt_siRNA[dt_control, on = c("Column", "Row")]

dt_layout
```

### Read and process the Columbus data

Set RegEx patterns for directory searches for logs file data and spot data on a per protocol step basis.

```{r regexFilename}
pat_col <- "*.result\\.1\\.txt"# Pattern for Columbus results files
```

Create a list of the RegEx patterns set in the previous chunk. **Important:** the list names will be carried over all the next steps!!!

-   col = Columbus data

```{r patList, results = 'hide'}
pat_list <- list(col = pat_col)

pat_list
```

Recursively search the working directory and its subdirectories for files whose name includes the RegEx patterns defined two chunks above. The `path_list` functon outputs absolute file names. `path_list` is a list containing all the filenames on a per Janus step basis.

```{r directorySearch, results='hide'}
list_files <- function(x){
  dir(path = "input", pattern = x, full.names = TRUE, recursive = TRUE, include.dirs = TRUE)
}

path_list <- llply(pat_list, list_files) 

path_list
```

Extract file names from absolute path and set them as list element names.

```{r trimNames, results='hide'}
trim_names <- function(x){
  names(x) <- basename(x) # This assigns the filename to the file that it is read
  y <- x ## This is necessary because of scoping issues
}

path_list <- llply(path_list, trim_names) 
```

Recursively read and merge object level data files as data.frames. Rows are labeled with relative filenames (The `.id` variable). This and the previous chunks are slightly modified tricks adopted from H. Wickam ["Tidy Data" paper](http://vita.had.co.nz/papers/tidy-data.pdf).

```{r readMerge, results='hide', warning=F}
read_merge <- function(x){
  dt <-as.data.table(ldply(x, fread, integer64 = "character")) 
}

dt_list <- llply(path_list, read_merge)
```

Separate Columbus data from the other classes of data.

```{r separateColumbusData}
dt_col <- dt_list$col

rm(dt_list)

glimpse(dt_col)
```

Rename variables

```{r}
setnames(dt_col, c("Nuclei Selected - Number of Objects",
                   "Nuclei Selected - Nucleus Area [µm²] - Mean per Well",
                   "Nuclei Selected - Nucleus Roundness - Mean per Well",
                   "Nuclei Selected - Intensity Nucleus Region Exp2Cam1 Mean - Mean per Well",
                   "Nuclei Selected - Intensity Nucleus Region Exp3Cam2 Mean - Mean per Well"),
                 c("cell_number",
                   "nuc_area",
                   "nuc_roundness",
                   "nuc_green_int",
                   "nuc_red_int"))

glimpse(dt_col)
```

Merge the Columbus measurements data with the layout data.

```{r resultsLayoutMerge}
dt_data <- dt_col[dt_layout, on = c("Column", "Row")]

glimpse(dt_data)
```

# Plot the data

```{r layoutPlot, echo=FALSE}
layout_plot <- ggplot(dt_data, aes(x = Column, y = Row, fill = treatment))

layout_plot + geom_tile(color = "black") +
    scale_y_reverse(breaks = 1:16, labels = LETTERS[1:16]) +
    scale_x_continuous(breaks = 1:24) +
    scale_fill_tableau(name = "siRNA") +
    ggtitle("siRNA Layout")
```

```{r n_cellsHeatmap, fig.height = 8, fig.width = 8, echo=FALSE}
n_cells_heatmap_plot <- ggplot(dt_data, aes(x = Column, y = Row, fill = cell_number))

n_cells_heatmap_plot + geom_tile(color = "black") +
    scale_y_reverse(breaks = 1:16, labels = LETTERS[1:16]) +
    scale_x_continuous(breaks = 1:24) +
    scale_fill_viridis("Cell Number") +
    facet_wrap(~ PlateName, ncol = 1) +
    ggtitle("Cells Number")
```

```{r areaHeatmap, fig.height = 8, fig.width = 8, echo=FALSE}
area_heatmap_plot <- ggplot(dt_data, aes(x = Column, y = Row, fill = nuc_area))

area_heatmap_plot + geom_tile(color = "black") +
    scale_y_reverse(breaks = 1:16, labels = LETTERS[1:16]) +
    scale_x_continuous(breaks = 1:24) +
    scale_fill_viridis("Area [µm²]") +
    facet_wrap(~ PlateName, ncol = 1) +
    ggtitle("Raw Area Measurement")
```

```{r roundHeatmap, fig.height = 8, fig.width = 8,, echo=FALSE}
round_heatmap_plot <- ggplot(dt_data, aes(x = Column, y = Row, fill = nuc_roundness))

round_heatmap_plot + geom_tile(color = "black") +
    scale_y_reverse(breaks = 1:16, labels = LETTERS[1:16]) +
    scale_x_continuous(breaks = 1:24) +
    scale_fill_viridis("Roundness") +
    facet_wrap(~ PlateName, ncol = 1) +
    ggtitle("Raw Roundness Measurement")
```

```{r nucRedHeatmap, fig.height = 8, fig.width = 8, echo=FALSE}
nuc_red_heatmap_plot <- ggplot(dt_data, aes(x = Column, y = Row, fill = nuc_red_int))

nuc_red_heatmap_plot + geom_tile(color = "black") +
    scale_y_reverse(breaks = 1:16, labels = LETTERS[1:16]) +
    scale_x_continuous(breaks = 1:24) +
    scale_fill_viridis(paste(red_name,"Nuclear Intensity (A.U.)")) +
    facet_wrap(~ PlateName, ncol = 1) +
    ggtitle(paste(red_name, "Nuclear Intensity"))
```

```{r nucgreenHeatmap, fig.height = 8, fig.width = 8, echo=FALSE}
nuc_green_heatmap_plot <- ggplot(dt_data, aes(x = Column, y = Row, fill = nuc_green_int))

nuc_green_heatmap_plot + geom_tile(color = "black") +
    scale_y_reverse(breaks = 1:16, labels = LETTERS[1:16]) +
    scale_x_continuous(breaks = 1:24) +
    scale_fill_viridis(paste(green_name,"Nuclear Intensity (A.U.)")) +
    facet_wrap(~ PlateName, ncol = 1) +
    ggtitle(paste(green_name, "Nuclear Intensity"))
```

Quite a few wells in HTIF00183 clearly had an issue, either due to the sample itself, or to the autofocus. For this reason, **these wells will be eliminated from the analysis**.

```{r}

excluded <- c("M7", "N7", "O7", "P7", "O8", "P8")

dt_data <- dt_data[!(PlateName == "HTIF00183" & WellName %in% excluded),]
```

Calculate the mean and standard devitation (SD) for the negative control siRNA on a per plate basis.

```{r}
dt_norm <-
    dt_data[treatment == "negative", .(
    neg_n_cells_mean = mean(cell_number, na.rm = TRUE),
    neg_n_cells_sd = sd(cell_number, na.rm = TRUE),
    neg_area_mean = mean(nuc_area, na.rm = TRUE),
    neg_area_sd = sd(nuc_area, na.rm = TRUE),
    neg_round_mean = mean(nuc_roundness, na.rm = TRUE),
    neg_round_sd = sd(nuc_roundness, na.rm = TRUE),
    neg_nuc_red_mean = mean(nuc_red_int, na.rm = TRUE),
    neg_nuc_red_sd = sd(nuc_red_int, na.rm = TRUE),
    neg_nuc_green_mean = mean(nuc_green_int, na.rm = TRUE),
    neg_nuc_green_sd = sd(nuc_green_int, na.rm = TRUE)
    ), by = .id]

glimpse(dt_norm)
```

Calculate Z-scores based on the mean and SD of the negative controls. Also calculate the negative control normalized values (On a per plate basis).

```{r}
dt_data <- dt_data[dt_norm, on = ".id"]

z_score <- function(measurement, average, s_dev){
           return((measurement - average)/s_dev)
}

norm_change <-function(measurement, average){
            return(100*(measurement/average))
}

dt_data[, `:=`(n_cells_z_score = z_score(cell_number, neg_n_cells_mean, neg_n_cells_sd),
               n_cells_norm_change = norm_change(cell_number, neg_n_cells_mean),
               area_z_score = z_score(nuc_area, neg_area_mean, neg_area_sd),
               area_norm_change = norm_change(nuc_area, neg_area_mean),
               round_z_score = z_score(nuc_roundness, neg_round_mean, neg_round_sd),
               round_norm_change = norm_change(nuc_roundness, neg_round_mean),
               nuc_red_z_score = z_score(nuc_red_int, neg_nuc_red_mean, neg_nuc_red_sd),
               nuc_red_norm_change = norm_change(nuc_red_int, neg_nuc_red_mean),
               nuc_green_z_score = z_score(nuc_green_int, neg_nuc_green_mean, neg_nuc_green_sd),
               nuc_green_norm_change = norm_change(nuc_green_int, neg_nuc_green_mean))]

glimpse(dt_data)
```

Write the data to a .csv file for further analysis

```{r}
write.table(dt_data, 
            paste("output/validation", red_name, green_name, "normalized_results.txt", sep = "_"),
            quote = FALSE,
            sep = "\t",
            row.names = FALSE, 
            col.names = TRUE)
```

Create a novel unique identifier for each oligo that contains also the gene symbol.

```{r}
dt_data[,oligo_name := paste(gene_symbol, str_extract(oligo_id, "[0-9]{2}$"), sep = "-")]
```

```{r n_cellsZPlot, fig.height=8, fig.width=25, echo=FALSE}
theme_update(axis.text.x=element_text(size = 6))

n_cells_plot_z<- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = n_cells_z_score))

n_cells_plot_z + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 0) +
            
            xlab("siRNA id") +
            ylab("Z-score +/- SD") +
            ggtitle("Cell Number")
```

```{r n_cellsNormPlot, fig.height=8, fig.width=25, echo=FALSE}
n_cells_plot_fold <- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = n_cells_norm_change))

n_cells_plot_fold + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 100) +
            
            xlab("siRNA id") +
            ylab("% Negative Control +/- SD") +
            ggtitle("Cell Number")
```

```{r areaZPlot, fig.height=8, fig.width=25, echo=FALSE}
area_plot_z<- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = area_z_score))

area_plot_z + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 0) +
            
            xlab("siRNA id") +
            ylab("Z-score +/- SD") +
            ggtitle("Nuclear Area")
```

```{r areaNormPlot, fig.height=8, fig.width=25, echo=FALSE}
area_plot_fold <- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = area_norm_change))

area_plot_fold + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 100) +
            
            xlab("siRNA id") +
            ylab("% Negative Control +/- SD") +
            ggtitle("Nuclear Area")
```

```{r roundZPlot, fig.height=8, fig.width=25, echo=FALSE}
round_plot_z<- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = round_z_score))

round_plot_z + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 0) +
            
            xlab("siRNA id") +
            ylab("Z-score +/- SD") +
            ggtitle("Nuclear Roundness")
```

```{r roundNormPlot, fig.height=8, fig.width=25, echo=FALSE}
round_plot_fold <- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = round_norm_change))

round_plot_fold + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 100) +
            
            xlab("siRNA id") +
            ylab("% Negative Control +/- SD") +
            ggtitle("Nuclear Roundness")
```

```{r nucRedZPlot, fig.height=8, fig.width=25, echo=FALSE}
nuc_red_plot_z<- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = nuc_red_z_score))

nuc_red_plot_z + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 0) +
            
            xlab("siRNA id") +
            ylab("Z-score +/- SD") +
            ggtitle(paste(red_name, "Nuclear Intensity"))
```

```{r nucRedNormPlot, fig.height=8, fig.width=25, echo=FALSE}
nuc_red_plot_fold <- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = nuc_red_norm_change))

nuc_red_plot_fold + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 100) +
            
            xlab("siRNA id") +
            ylab("% Negative Control +/- SD") +
            ggtitle(paste(red_name, "Nuclear Intensity"))
```

```{r nucgreenZPlot, fig.height=8, fig.width=25, echo=FALSE}
nuc_green_plot_z<- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = nuc_green_z_score))

nuc_green_plot_z + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 0) +
            
            xlab("siRNA id") +
            ylab("Z-score +/- SD") +
            ggtitle(paste(green_name, "Nuclear Intensity"))
```

```{r nucgreenNormPlot, fig.height=8, fig.width=25, echo=FALSE}
nuc_green_plot_fold <- ggplot(dt_data[!(is.na(oligo_id)),], aes(x = oligo_name, y = nuc_green_norm_change))

nuc_green_plot_fold + stat_summary(fun.data = "mean_sdl", fun.args = list(mult = 1)) + 
            geom_hline(yintercept = 100) +
            
            xlab("siRNA id") +
            ylab("% Negative Control +/- SD") +
            ggtitle(paste(green_name, "Nuclear Intensity"))
```

Aggregate the biological repeats (The two different plates) by calculating the mean and SD for all the variables (Z-scores and fold changes). **n = 2**.

```{r}
dt_aggregated <- dt_data %>% 
        group_by(gene_symbol,
                 gene_id,
                 oligo_id,
                 oligo_name,
                 sequence) %>%
        summarise(across(n_cells_z_score:nuc_green_norm_change, list(mean, sd))) %>%
        arrange(oligo_name)

write.table(dt_aggregated, 
            paste("output/validation", red_name, green_name, "aggregated_results.txt", sep = "_"),
            quote = FALSE,
            sep = "\t",
            row.names = FALSE, 
            col.names = TRUE)
```

Document the information about the analysis session

```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
sessionInfo()
```
